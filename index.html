<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Consola de Inversi√≥n 80/20 - Plan Maestro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Reset preventivo para evitar scroll horizontal */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f4f7f9; 
            color: #333; 
            padding: 15px;
            overflow-x: hidden; /* Garantiza que nada salga por los lados */
            width: 100%;
        }

        .container { width: 100%; max-width: 1200px; margin: auto; }
        
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { font-size: 1.5em; margin-bottom: 15px; color: #2c3e50; }

        /* Banner optimizado para no desbordar */
        .total-banner { 
            display: flex; 
            flex-direction: column; 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px;
            gap: 15px;
        }

        .banner-item { text-align: center; width: 100%; }
        .stat-label { font-size: 0.85em; opacity: 0.8; margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-size: 1.4em; font-weight: bold; display: block; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }

        .card { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            width: 100%;
        }

        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: #2c3e50; font-size: 1.2em; }
        
        /* Gesti√≥n de Tabla vs Cards */
        .table-container { display: none; } /* Oculta tabla por defecto (m√≥vil primero) */
        
        .asset-card { 
            background: #fff;
            border: 1px solid #edf2f7;
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 12px;
            word-break: break-word;
        }

        .asset-card-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 12px;
            gap: 10px;
        }

        .asset-card-title { font-weight: bold; font-size: 1em; color: #2d3748; }

        .asset-card-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px 0;
            border-top: 1px solid #f7fafc;
            font-size: 0.9em;
        }

        /* Botones adaptados */
        .btn { 
            width: 100%;
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer;
            margin-bottom: 10px;
        }
        .btn-primary { background: #3182ce; color: white; }
        .btn-action { width: auto; padding: 6px 10px; margin: 0; }

        /* Gr√°ficos */
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 30px; }

        /* Modal Ultra-Responsive */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 20px; 
            border-radius: 12px; 
            width: 92%; 
            max-height: 90vh; 
            overflow-y: auto; 
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; }

                .tag-solid { background: #f0fff4; color: #38a169; }

        /* Toggle Switch */
        .toggle-container { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 15px;
        }

        .toggle-switch { 
            position: relative; 
            width: 50px; 
            height: 26px; 
            background: #ccc; 
            border-radius: 13px; 
            cursor: pointer; 
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch.active { background: #3182ce; }

        .toggle-slider { 
            position: absolute; 
            top: 3px; 
            left: 3px; 
            width: 20px; 
            height: 20px; 
            background: white; 
            border-radius: 50%; 
            transition: left 0.3s;
            pointer-events: none;
        }

        .toggle-switch.active .toggle-slider { left: 24px; }

        .toggle-label { font-size: 0.9em; color: #666; font-weight: 500; }

        /* Desktop View (Tablets y PCs) */
        @media (min-width: 768px) {
            body { padding: 30px; }
            .total-banner { flex-direction: row; }
            .grid { grid-template-columns: 350px 1fr; }
            .table-container { display: block; overflow-x: auto; }
            .asset-cards { display: none; }
            .btn { width: auto; }
            .header { display: flex; justify-content: space-between; align-items: center; text-align: left; }
            .header h1 { margin: 0; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { cursor: pointer; background: #f8fafc; }
        }

        .tag { padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; }
        .tag-core { background: #ebf8ff; color: #2b6cb0; }
        .tag-sat { background: #fffaf0; color: #dd6b20; }
        .tag-solid { background: #f0fff4; color: #38a169; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Mi Estrategia 80/20</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="toggle-container">
                <span class="toggle-label">Ocultar valores</span>
                <div class="toggle-switch" id="hideValuesToggle" onclick="toggleHideValues()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="openModal()">+ A√±adir Activo</button>
        </div>
    </div>

    <div class="total-banner" id="totalBanner"></div>

    <div class="grid">
        <div class="card">
            <h2>Distribuci√≥n</h2>
            <div class="chart-container"><canvas id="categoryChart"></canvas></div>
            <div class="chart-container"><canvas id="sourceChart"></canvas></div>
        </div>

        <div class="card">
            <h2>Mis Activos</h2>
            
            <!-- Mobile View -->
            <div id="assetCards" class="asset-cards"></div>

            <!-- Desktop View -->
            <div class="table-container">
                <table id="assetTable">
                    <thead>
                        <tr>
                            <th onclick="sortData('name')">Activo</th>
                            <th onclick="sortData('source')">Origen</th>
                            <th onclick="sortData('cat')">Cat.</th>
                            <th onclick="sortData('val')">Valor</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="assetTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Form -->
<div id="assetModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Nuevo Activo</h2>
        <form id="assetForm" onsubmit="saveAsset(event)">
            <div class="form-group"><label>Nombre</label><input type="text" id="assetName" required></div>
            <div class="form-group">
                <label>Origen</label>
                <select id="assetSource">
                    <option value="DEGIRO">DEGIRO</option>
                    <option value="Revolut">Revolut</option>
                    <option value="Binance">Binance</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Categor√≠a</label>
                <select id="assetCat">
                    <option value="Core">Core</option>
                    <option value="Sat√©lite">Sat√©lite</option>
                    <option value="S√≥lido">S√≥lido</option>
                </select>
            </div>
            <div class="form-group"><label>Valor (‚Ç¨)</label><input type="number" step="0.01" id="assetVal" required></div>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            <button type="button" class="btn" style="background:#edf2f7" onclick="closeModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
    // CONFIGURACI√ìN SUPABASE (Rellena con tus datos)
    const SUPABASE_URL = 'https://srkwhattinvfzpqibfqf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_3lkA4murY7uF0IIYz-vDcQ_r6gh_hkD';
    const clientSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let assets = [];
    let charts = {};
    let editingIdx = -1;
    let hideValues = false;

    function toggleHideValues() {
        hideValues = !hideValues;
        document.getElementById('hideValuesToggle').classList.toggle('active');
        localStorage.setItem('hideValues', hideValues);
        renderUI();
        updateCharts();
    }

    async function initData() {
        hideValues = localStorage.getItem('hideValues') === 'true';
        if (hideValues) document.getElementById('hideValuesToggle').classList.add('active');

        const { data, error } = await clientSupabase
            .from('jsonPortfolio') // Aseg√∫rate de que este es el nombre de tu tabla
            .select('data')
            .eq('id', 1)
            .single();

        if (data) {
            assets = data.data;
            console.log("Datos sincronizados desde Supabase");
        } else {
            console.warn("Fallo carga nube, usando local:", error);
            assets = JSON.parse(localStorage.getItem('invest_v3')) || [];
        }
        renderUI();
        updateCharts();
    }

    async function syncCloud() {
        localStorage.setItem('invest_v3', JSON.stringify(assets));
        
        const { error } = await clientSupabase
            .from('jsonPortfolio') // Mismo nombre que en initData
            .update({ data: assets })
            .eq('id', 1);

        if (error) console.error("Error al sincronizar:", error);
        else console.log("Sincronizado con la nube con √©xito");
        
        renderUI();
        updateCharts();
    }

    function renderUI() {
        const total = assets.reduce((s, a) => s + a.val, 0);
        const solid = assets.filter(a => a.cat === 'S√≥lido').reduce((s, a) => s + a.val, 0);
        const solidPct = total > 0 ? ((solid/total)*100).toFixed(1) : 0;

        const displayVal = hideValues ? '***' : total.toLocaleString() + ' ‚Ç¨';
        const displaySolid = hideValues ? '***' : solid.toLocaleString() + ' ‚Ç¨';

        document.getElementById('totalBanner').innerHTML = `
            <div class="banner-item"><span class="stat-label">Patrimonio Total</span><span class="stat-val">${displayVal}</span></div>
            <div class="banner-item"><span class="stat-label">Base S√≥lida (Objetivo 20%)</span><span class="stat-val" style="color:#81c784">${solidPct}%</span></div>
            <div class="banner-item"><span class="stat-label">Renta Variable</span><span class="stat-val" style="color:#64b5f6">${(100-solidPct).toFixed(1)}%</span></div>
        `;

        const container = document.getElementById('assetCards');
        const tbody = document.getElementById('assetTableBody');
        container.innerHTML = '';
        tbody.innerHTML = '';

        assets.forEach((a, i) => {
            const tagClass = `tag tag-${a.cat.toLowerCase().replace('√©','e')}`;
            const displayAssetVal = hideValues ? '***' : a.val.toLocaleString() + ' ‚Ç¨';

            container.innerHTML += `
                <div class="asset-card">
                    <div class="asset-card-header">
                        <span class="asset-card-title">${a.name}</span>
                        <div>
                            <button class="btn-action" onclick="editAsset(${i})">‚úèÔ∏è</button>
                            <button class="btn-action" onclick="deleteAsset(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="asset-card-row"><span>Origen</span><b>${a.source}</b></div>
                    <div class="asset-card-row"><span>Cat.</span><span class="${tagClass}">${a.cat}</span></div>
                    <div class="asset-card-row"><span>Valor</span><b onclick="quickEdit(${i})" style="cursor:pointer">${displayAssetVal}</b></div>
                </div>`;

            tbody.innerHTML += `
                <tr>
                    <td>${a.name}</td>
                    <td>${a.source}</td>
                    <td><span class="${tagClass}">${a.cat}</span></td>
                    <td onclick="quickEdit(${i})" style="cursor:pointer"><b>${displayAssetVal}</b></td>
                    <td>
                        <button class="btn-action" onclick="editAsset(${i})">‚úèÔ∏è</button>
                        <button class="btn-action" onclick="deleteAsset(${i})">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    }

    function updateCharts() {
        const cats = { Core: 0, Sat√©lite: 0, S√≥lido: 0 };
        const srcs = {};
        assets.forEach(a => {
            cats[a.cat] += a.val;
            srcs[a.source] = (srcs[a.source] || 0) + a.val;
        });

        const setupChart = (data, el, type) => {
            if (charts[el]) charts[el].destroy();
            charts[el] = new Chart(document.getElementById(el), {
                type: type,
                data: {
                    labels: Object.keys(data),
                    datasets: [{ data: Object.values(data), backgroundColor: ['#3182ce', '#dd6b20', '#38a169', '#718096'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });
        };
        setupChart(cats, 'categoryChart', 'doughnut');
        setupChart(srcs, 'sourceChart', 'pie');
    }

    function openModal() { editingIdx = -1; document.getElementById('assetForm').reset(); document.getElementById('assetModal').style.display='block'; }
    function closeModal() { document.getElementById('assetModal').style.display='none'; }
    
    function saveAsset(e) {
        e.preventDefault();
        const obj = {
            name: document.getElementById('assetName').value,
            source: document.getElementById('assetSource').value,
            cat: document.getElementById('assetCat').value,
            val: parseFloat(document.getElementById('assetVal').value)
        };
        if (editingIdx > -1) assets[editingIdx] = obj;
        else assets.push(obj);
        closeModal();
        syncCloud();
    }

    function quickEdit(i) {
        const n = prompt("Nuevo valor para " + assets[i].name, assets[i].val);
        if (n !== null && !isNaN(n)) { assets[i].val = parseFloat(n); syncCloud(); }
    }

    function deleteAsset(i) { if(confirm("¬øEliminar activo?")) { assets.splice(i, 1); syncCloud(); } }

    function sortData(key) {
        assets.sort((a,b) => typeof a[key] === 'string' ? a[key].localeCompare(b[key]) : b[key] - a[key]);
        renderUI();
    }

    function editAsset(i) {
        editingIdx = i;
        const a = assets[i];
        document.getElementById('assetName').value = a.name;
        document.getElementById('assetSource').value = a.source;
        document.getElementById('assetCat').value = a.cat;
        document.getElementById('assetVal').value = a.val;
        document.getElementById('assetModal').style.display='block';
    }

    // Inicializar cargando desde la nube
    window.onload = initData;
    window.addEventListener('resize', updateCharts);
</script>
</body>
</html>